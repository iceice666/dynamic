---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TOCWidget from '../../components/TOCWidget.astro';
import { getCollection, render } from 'astro:content';
import { entrySlug } from '../../utils';

export async function getStaticPaths() {
  const articles = await getCollection('articles', ({ data }) => !data.draft);
  return articles.map((entry) => ({
    params: { slug: entrySlug(entry.id) },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

// Look up translation partner
let translationEntry = null;
if (entry.data.translationOf) {
  const all = await getCollection('articles', ({ data }) => !data.draft);
  translationEntry = all.find((a) => entrySlug(a.id) === entry.data.translationOf) ?? null;
}

const contentLang = entry.data.lang === 'zh-tw' ? 'zh-TW' : 'en';
---

<BaseLayout title={entry.data.title} toc={headings} contentLang={contentLang}>
  <article class="prose prose-lg max-w-none">
    {
      translationEntry && (
        <div class="not-prose border-accent/20 bg-accent/5 mb-6 rounded-lg border p-3">
          <a
            href={`/articles/${entrySlug(translationEntry.id)}`}
            class="text-accent text-sm no-underline hover:opacity-75"
          >
            <span data-i18n-en>
              Read in {translationEntry.data.lang === 'zh-tw' ? 'Chinese' : 'English'} →
            </span>
            <span data-i18n-zh-tw>
              閱讀{translationEntry.data.lang === 'zh-tw' ? '中文' : '英文'}版本 →
            </span>
          </a>
        </div>
      )
    }
    <h1>{entry.data.title}</h1>
    {entry.data.description && <p class="lead">{entry.data.description}</p>}
    <div class="not-prose mb-6 flex flex-wrap gap-1.5">
      {
        entry.data.tags.map((tag) => (
          <a href={`/search?q=%23${tag}`} class="text-accent text-xs no-underline hover:opacity-75">
            #{tag}
          </a>
        ))
      }
    </div>
    <Content />
  </article>

  <TOCWidget slot="right-panel" headings={headings} />
</BaseLayout>
