---
import BaseLayout from '$/layouts/BaseLayout.astro';
import AuthorBio from '$/components/cards/AuthorBio';
import { t } from '$/i18n';
import ArticleViewCount from '$/components/widgets/ArticleViewCount';
import GiscusComments from '$/components/GiscusComments';
import { getCollection, render } from 'astro:content';
import { entrySlug, formatDate } from '$/utils';
import { Calendar, BookOpen, Clock } from 'lucide-react';

const slug = Astro.params.slug;
const articles = await getCollection('articles', ({ data }) => !data.draft);
const entry = articles.find((a) => entrySlug(a.id) === slug);

// Safety check: ensure entry exists
if (!entry) {
  return Astro.redirect('/404');
}

const { Content, headings, remarkPluginFrontmatter } = await render(entry);

const title = entry.data.title ?? remarkPluginFrontmatter?.extractedTitle ?? 'Untitled';
const description = entry.data.description ?? remarkPluginFrontmatter?.extractedDescription;

// Look up translation partner
let translationEntry = null;
if (entry.data.translationOf) {
  const all = await getCollection('articles', ({ data }) => !data.draft);
  translationEntry = all.find((a) => entrySlug(a.id) === entry.data.translationOf) ?? null;
}

const contentLang = entry.data.lang === 'zh-tw' ? 'zh-TW' : 'en';

const wc: number = remarkPluginFrontmatter?.wordCount ?? 0;
const mins: number = remarkPluginFrontmatter?.readingTime ?? 1;

const { locale } = Astro.locals;
---

<BaseLayout title={title} toc={headings} contentLang={contentLang}>
  <article class="prose prose-lg max-w-none">
    {
      translationEntry && (
        <div class="not-prose border-accent/20 bg-accent/5 mb-6 rounded-lg border p-3">
          <a
            href={`/articles/${entrySlug(translationEntry.id)}`}
            class="text-accent text-sm no-underline hover:opacity-75"
          >
            {translationEntry.data.lang === 'zh-tw'
              ? t(locale, 'article_read_in_chinese')
              : t(locale, 'article_read_in_english')}
          </a>
        </div>
      )
    }
    <h1>{title}</h1>
    {description && <p class="lead">{description}</p>}
    <div class="not-prose mb-6 flex flex-wrap items-center gap-x-3 gap-y-1.5">
      {
        entry.data.tags.map((tag: string) => (
          <a href={`/search?q=%23${tag}`} class="text-accent text-xs no-underline hover:opacity-75">
            #{tag}
          </a>
        ))
      }
      {
        entry.data.tags.length > 0 && (
          <span class="text-border" aria-hidden="true">
            |
          </span>
        )
      }
      <span class="text-muted flex items-center gap-1 text-xs">
        <Calendar size={12} aria-hidden="true" />
        <time datetime={entry.data.publishedAt.toISOString()}
          >{formatDate(entry.data.publishedAt)}</time
        >
      </span>
      <span class="text-muted flex items-center gap-1 text-xs">
        <BookOpen size={12} aria-hidden="true" />
        <span>{wc.toLocaleString()} {t(locale, 'article_word_count')}</span>
      </span>
      <span class="text-muted flex items-center gap-1 text-xs">
        <Clock size={12} aria-hidden="true" />
        <span>{mins} {t(locale, 'article_read_time')}</span>
      </span>
      <ArticleViewCount client:idle path={Astro.url.pathname} />
    </div>
    <hr class="not-prose border-border mb-8" />
    <Content />
  </article>

  <GiscusComments client:idle />

  <div class="sm:hidden">
    <AuthorBio client:load />
  </div>
</BaseLayout>
