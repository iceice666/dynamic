---
import BaseLayout from '$/layouts/BaseLayout.astro';
import { t } from '$/i18n';
import { getCollection, render } from 'astro:content';
import { parseArticleId, formatDate, formatCategory } from '$/utils';

const { locale } = Astro.locals;

const articlesRaw = await getCollection('articles', ({ data }) => !data.draft);

// Compute category counts
const categoryMap = new Map<string, { name: string; count: number }>();
for (const entry of articlesRaw) {
  const slug = entry.data.category;
  if (!slug) continue;
  const name = formatCategory(slug);
  const existing = categoryMap.get(slug);
  if (existing) {
    existing.count++;
  } else {
    categoryMap.set(slug, { name, count: 1 });
  }
}
const categoryCounts = Array.from(categoryMap.entries())
  .map(([slug, { name, count }]) => ({ slug, name, count }))
  .sort((a, b) => b.count - a.count);

// Compute tag counts
const tagMap = new Map<string, number>();
for (const entry of articlesRaw) {
  for (const tag of entry.data.tags ?? []) {
    tagMap.set(tag, (tagMap.get(tag) ?? 0) + 1);
  }
}
const tagCounts = Array.from(tagMap.entries())
  .map(([tag, count]) => ({ tag, count }))
  .sort((a, b) => b.count - a.count);

const archiveEntries = await Promise.all(
  articlesRaw.map(async (entry) => {
    const { remarkPluginFrontmatter } = await render(entry);
    const { slug, lang: fileLang } = parseArticleId(entry.id);
    const articleLang = fileLang ?? entry.data.lang ?? 'en';
    return {
      title: entry.data.title ?? remarkPluginFrontmatter?.extractedTitle ?? slug,
      slug,
      translationLang: articleLang,
      publishedAt: entry.data.publishedAt,
    };
  })
);
archiveEntries.sort((a, b) => b.publishedAt.getTime() - a.publishedAt.getTime());

const archiveGroups = new Map<number, typeof archiveEntries>();
for (const entry of archiveEntries) {
  const year = entry.publishedAt.getFullYear();
  const existing = archiveGroups.get(year);
  if (existing) {
    existing.push(entry);
  } else {
    archiveGroups.set(year, [entry]);
  }
}
const archiveYears = Array.from(archiveGroups.entries())
  .sort((a, b) => b[0] - a[0])
  .map(([year, items]) => ({ year, items }));
---

<BaseLayout title={t(locale, 'page_archive_heading')}>
  <div class="flex flex-col gap-6">
    <h1 class="text-foreground m-0 mb-2 text-2xl font-bold">
      {t(locale, 'page_archive_heading')}
    </h1>

    <div class="grid grid-cols-2 gap-6">
      <!-- Categories -->
      <section class="flex flex-col gap-3">
        <h2 class="text-foreground m-0 text-lg font-bold">
          {t(locale, 'page_categories_heading')}
        </h2>
        {
          categoryCounts.length > 0 ? (
            <ul class="m-0 flex list-none flex-col gap-2 p-0">
              {categoryCounts.map(({ slug, name, count }) => (
                <li>
                  <a
                    href={`/search?q=@${slug}`}
                    class="border-border bg-background hover:bg-muted-bg flex items-center justify-between rounded-lg border px-4 py-3 no-underline transition-colors duration-150"
                  >
                    <span class="text-foreground text-sm font-medium">{name}</span>
                    <span class="text-muted text-xs">{count}</span>
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <p class="text-muted text-sm">No categories yet.</p>
          )
        }
      </section>

      <!-- Tags -->
      <section class="flex flex-col gap-3">
        <h2 class="text-foreground m-0 text-lg font-bold">{t(locale, 'page_tags_heading')}</h2>
        {
          tagCounts.length > 0 ? (
            <div class="flex flex-wrap gap-2">
              {tagCounts.map(({ tag, count }) => (
                <a
                  href={`/search?q=%23${tag}`}
                  class="bg-muted-bg text-muted hover:text-foreground hover:bg-accent/10 rounded-full px-3 py-1 text-xs no-underline transition-colors duration-150"
                >
                  #{tag} <span class="opacity-60">({count})</span>
                </a>
              ))}
            </div>
          ) : (
            <p class="text-muted text-sm">No tags yet.</p>
          )
        }
      </section>
    </div>

    {
      archiveYears.map(({ year, items }) => (
        <section class="flex flex-col gap-3">
          <div class="flex items-baseline justify-between gap-4">
            <h2 class="text-foreground m-0 text-xl font-bold">{year}</h2>
            <div class="text-muted text-sm">
              {items.length}{' '}
              {locale === 'en'
                ? items.length === 1
                  ? t(locale, 'archive_article_singular')
                  : t(locale, 'archive_article_plural')
                : t(locale, 'archive_article_plural')}
            </div>
          </div>
          <ul class="m-0 flex list-none flex-col gap-2 p-0">
            {items.map((entry) => (
              <li>
                <a
                  href={`/articles/${entry.slug}${entry.translationLang !== 'en' ? `?lang=${entry.translationLang}` : ''}`}
                  class="border-border bg-background hover:bg-muted-bg flex items-center gap-3 rounded-lg border px-4 py-3 no-underline transition-colors duration-150"
                >
                  <time
                    class="text-muted font-mono text-xs"
                    datetime={entry.publishedAt.toISOString()}
                  >
                    {formatDate(entry.publishedAt)}
                  </time>
                  <span class="text-foreground font-medium">{entry.title}</span>
                  {entry.translationLang && (
                    <span class="border-border rounded border px-1 py-0.5 text-[0.6rem] font-semibold tracking-wider uppercase opacity-60">
                      {entry.translationLang}
                    </span>
                  )}
                </a>
              </li>
            ))}
          </ul>
        </section>
      ))
    }
    {archiveYears.length === 0 && <p class="text-muted">No articles yet.</p>}
  </div>
</BaseLayout>
