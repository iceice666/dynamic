---
import BaseLayout from '$/layouts/BaseLayout.astro';
import ArticleCard from '$/components/cards/ArticleCard.astro';
import PostCard from '$/components/cards/PostCard.astro';
import { t } from '$/i18n';
import { getCollection, render } from 'astro:content';
import { parseArticleId } from '$/utils';

const { locale } = Astro.locals;

const articlesRaw = await getCollection('articles', ({ data }) => !data.draft);

const articles = await Promise.all(
  articlesRaw.map(async (entry) => {
    const { remarkPluginFrontmatter } = await render(entry);
    const { slug, lang: fileLang } = parseArticleId(entry.id);
    const articleLang = fileLang ?? entry.data.lang ?? 'en';
    return {
      type: 'article' as const,
      slug,
      translationLang: articleLang,
      publishedAt: entry.data.publishedAt,
      data: {
        ...entry.data,
        title: entry.data.title ?? remarkPluginFrontmatter?.extractedTitle ?? slug,
        description: entry.data.description ?? remarkPluginFrontmatter?.extractedDescription,
      },
      wordCount: remarkPluginFrontmatter?.wordCount ?? 0,
      readingTime: remarkPluginFrontmatter?.readingTime ?? 1,
      body: entry.body ?? '',
    };
  })
);

const postsRaw = await getCollection('posts');
const posts = await Promise.all(
  postsRaw.map(async (entry) => {
    const { remarkPluginFrontmatter } = await render(entry);
    return {
      type: 'post' as const,
      slug: parseArticleId(entry.id).slug,
      publishedAt: entry.data.publishedAt ?? remarkPluginFrontmatter?.publishedAt ?? new Date(),
      data: {
        ...entry.data,
        tags: entry.data.tags ?? remarkPluginFrontmatter?.tags ?? [],
      },
      body: entry.body ?? '',
    };
  })
);

const feed = [...articles, ...posts].sort(
  (a, b) => b.publishedAt.getTime() - a.publishedAt.getTime()
);
---

<BaseLayout title="Feed">
  <div class="flex flex-col gap-4">
    <h1 class="text-foreground m-0 mb-2 text-2xl font-bold">{t(locale, 'nav_feed')}</h1>
    {
      feed.map((item) =>
        item.type === 'article' ? (
          <ArticleCard
            title={item.data.title}
            description={item.data.description}
            slug={item.slug}
            publishedAt={item.publishedAt}
            tags={item.data.tags}
            categoryName={item.data.categoryName}
            wordCount={item.wordCount}
            readingTime={item.readingTime}
            translationLang={item.translationLang}
          />
        ) : (
          <PostCard publishedAt={item.publishedAt} tags={item.data.tags}>
            <p>{item.body}</p>
          </PostCard>
        )
      )
    }
  </div>
</BaseLayout>
