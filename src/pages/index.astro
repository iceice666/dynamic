---
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import PostCard from '../components/PostCard.astro';
import I18nText from '../components/I18nText.astro';
import { getCollection, render } from 'astro:content';
import { entrySlug } from '../utils';

const articlesRaw = await getCollection('articles', ({ data }) => !data.draft);
const articles = await Promise.all(
  articlesRaw.map(async (entry) => {
    const { remarkPluginFrontmatter } = await render(entry);
    return {
      type: 'article' as const,
      slug: entrySlug(entry.id),
      publishedAt: entry.data.publishedAt,
      data: {
        ...entry.data,
        title: entry.data.title ?? remarkPluginFrontmatter?.extractedTitle ?? entrySlug(entry.id),
        description: entry.data.description ?? remarkPluginFrontmatter?.extractedDescription,
      },
      body: entry.body ?? '',
    };
  })
);

const posts = (await getCollection('posts', ({ data }) => !data.draft)).map((entry) => ({
  type: 'post' as const,
  slug: entrySlug(entry.id),
  publishedAt: entry.data.publishedAt,
  data: entry.data,
  body: entry.body ?? '',
}));

const feed = [...articles, ...posts].sort(
  (a, b) => b.publishedAt.getTime() - a.publishedAt.getTime()
);
---

<BaseLayout title="Feed">
  <div class="flex flex-col gap-4">
    <h1 class="text-foreground m-0 mb-2 text-2xl font-bold"><I18nText k="nav_feed" /></h1>
    {
      feed.map((item) =>
        item.type === 'article' ? (
          <ArticleCard
            title={item.data.title}
            description={item.data.description}
            slug={item.slug}
            publishedAt={item.publishedAt}
            tags={item.data.tags}
            categoryName={item.data.categoryName}
          />
        ) : (
          <PostCard publishedAt={item.publishedAt} tags={item.data.tags}>
            <p>{item.body}</p>
          </PostCard>
        )
      )
    }
  </div>
</BaseLayout>
