---
import BaseLayout from '$/layouts/BaseLayout.astro';
import { t } from '$/i18n';
import ArticleViewCount from '$/components/widgets/ArticleViewCount';
import GiscusComments from '$/components/GiscusComments';
import { getCollection, render } from 'astro:content';
import { entrySlug, formatDate } from '$/utils';
import { Calendar } from 'lucide-react';

const id = Astro.params.id;
const posts = await getCollection('posts');
const entry = posts.find((p) => entrySlug(p.id) === id);

// Safety check: ensure entry exists
if (!entry) {
  return Astro.redirect('/404');
}

const { Content, remarkPluginFrontmatter } = await render(entry);
const { locale } = Astro.locals;
const publishedAt: Date =
  entry.data.publishedAt ?? remarkPluginFrontmatter?.publishedAt ?? new Date();
---

<BaseLayout title={t(locale, 'post_label')}>
  <article class="prose prose-lg max-w-none">
    <div class="not-prose text-muted mb-4 text-[0.6875rem] font-semibold tracking-widest uppercase">
      {t(locale, 'post_label')}
    </div>
    <Content />
    <div class="not-prose mt-4 flex flex-wrap items-center gap-x-3 gap-y-1.5">
      {
        (entry.data.tags ?? remarkPluginFrontmatter?.tags ?? []).map((tag: string) => (
          <a href={`/search?q=%23${tag}`} class="text-accent text-xs no-underline hover:opacity-75">
            #{tag}
          </a>
        ))
      }
      <span class="text-muted flex items-center gap-1 text-xs">
        <Calendar size={12} aria-hidden="true" />
        <time datetime={publishedAt.toISOString()}>{formatDate(publishedAt)}</time>
      </span>
      <ArticleViewCount client:idle path={Astro.url.pathname} />
    </div>
  </article>

  <GiscusComments client:idle />
</BaseLayout>
