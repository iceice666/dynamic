---
import { ClientRouter, fade } from 'astro:transitions';
import '../../styles/global.css';
import 'katex/dist/katex.min.css';
import '@fontsource-variable/noto-sans-tc';
import '@fontsource-variable/cascadia-code';
import LeftNav from '$/components/nav/LeftNav.astro';
import BottomNav from '$/components/nav/BottomNav.astro';
import ThemeButton from '$/components/controls/ThemeButton';
import LanguageToggle from '$/components/controls/LanguageToggle';
import React from 'react';

interface Props {
  title: string;
  contentLang?: string;
  toc?: { depth: number; slug: string; text: string }[];
}

const { title, contentLang, toc } = Astro.props;
---

<!doctype html>
<html lang={contentLang || 'en'} transition:animate="none">
  <head>
    <ClientRouter />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <!-- Blocking script: apply dark class + accent hue before paint (no FOUC) -->
    <script is:inline>
      var THEME_HANDLER_KEY = '__dynamicApplyThemeSettingsHandler__';

      function resolveTargetDocument(input) {
        if (input && input.documentElement) return input;
        if (input && input.newDocument && input.newDocument.documentElement)
          return input.newDocument;
        return document;
      }

      function applyThemeSettings(target) {
        const targetDocument = resolveTargetDocument(target);
        const root = targetDocument.documentElement;
        const theme = localStorage.getItem('dynamic:theme') || 'system';
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (theme === 'dark' || (theme === 'system' && prefersDark)) {
          root.classList.add('dark');
        } else {
          root.classList.remove('dark');
        }

        // Always set accent-hue to a valid value first (even if rainbow is active)
        const hue = localStorage.getItem('dynamic:accent-hue') || '255';
        root.style.setProperty('--accent-hue', hue);

        const rainbow = localStorage.getItem('dynamic:rainbow-mode') === 'true';
        if (rainbow) {
          const rawSpeed = parseInt(localStorage.getItem('dynamic:rainbow-speed') || '20', 10);
          const speed = Number.isFinite(rawSpeed) ? rawSpeed : 20;
          const duration = 60 - (speed / 100) * 58;
          root.style.setProperty('--rainbow-duration', duration + 's');
          // Use requestAnimationFrame to ensure hue is set before animation starts
          requestAnimationFrame(() => {
            root.classList.add('rainbow-active');
          });
        } else {
          root.classList.remove('rainbow-active');
        }

        const lang = localStorage.getItem('dynamic:lang') || 'en';
        root.dataset.lang = lang;
        if (!root.getAttribute('data-content-lang')) {
          root.lang = lang === 'zh-tw' ? 'zh-TW' : 'en';
        }

        // Update i18n aria-label attributes
        const ariaAttr = 'data-aria-' + lang;
        targetDocument.querySelectorAll('[' + ariaAttr + ']').forEach(function (el) {
          el.setAttribute('aria-label', el.getAttribute(ariaAttr));
        });
      }

      // Apply on initial load
      applyThemeSettings();

      // Reapply on View Transitions navigation
      const previousThemeHandler = window[THEME_HANDLER_KEY];
      if (typeof previousThemeHandler === 'function') {
        document.removeEventListener('astro:page-load', previousThemeHandler);
      }
      window[THEME_HANDLER_KEY] = applyThemeSettings;
      document.addEventListener('astro:page-load', () => applyThemeSettings());
      document.addEventListener('astro:before-swap', (event) => applyThemeSettings(event));
    </script>
  </head>
  <body>
    <React.StrictMode>
      <div class="site-layout">
        <!-- Left: Nav -->
        <aside class="left-col">
          <div class="left-col-inner">
            <LeftNav currentPath={Astro.url.pathname} toc={toc} />
          </div>
        </aside>

        <!-- Center: Content -->
        <main class="center-col" transition:animate={fade({ duration: '0.2s' })}>
          <slot />
        </main>

        <!-- Right: Panel (hidden, reserved for future use) -->
        <aside class="right-col">
          <div class="right-col-inner">
            <slot name="right-panel" />
          </div>
        </aside>
      </div>
      <BottomNav currentPath={Astro.url.pathname} toc={toc} />

      <!-- Floating FABs: Theme & Language (desktop only) -->
      <div class="floating-controls" transition:persist>
        <div class="fab-btn">
          <ThemeButton client:load compact align="right" />
        </div>
        <div class="fab-btn">
          <LanguageToggle client:load compact align="right" />
        </div>
      </div>

      <!-- Code block copy button handler -->
      <script>
        function initCopyButtons() {
          document.querySelectorAll<HTMLButtonElement>('.code-block-copy').forEach((btn) => {
            btn.addEventListener('click', async () => {
              const wrapper = btn.closest('.code-block-wrapper');
              const code = wrapper?.querySelector('pre code');
              if (!code) return;

              try {
                await navigator.clipboard.writeText(code.textContent || '');
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                  btn.textContent = 'Copy';
                  btn.classList.remove('copied');
                }, 2000);
              } catch {
                btn.textContent = 'Failed';
                setTimeout(() => {
                  btn.textContent = 'Copy';
                }, 2000);
              }
            });
          });
        }

        initCopyButtons();
        document.addEventListener('astro:page-load', initCopyButtons);
      </script>
    </React.StrictMode>
  </body>
</html>

<style>
  .site-layout {
    display: grid;
    grid-template-columns: clamp(200px, 22vw, 280px) 1fr;
    grid-template-areas: 'left center';
    min-height: 100vh;
    max-width: 1200px;
    margin: 0 auto;
  }

  .left-col {
    grid-area: left;
    border-right: 1px solid var(--color-border);
    position: sticky;
    top: 0;
    height: 100vh;
    overflow: hidden;
  }

  .left-col-inner {
    height: 100%;
  }

  .center-col {
    grid-area: center;
    min-width: 0;
    padding: 2rem 1.5rem;
  }

  .right-col {
    display: none;
  }

  .floating-controls {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 8;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .fab-btn {
    width: 2.75rem;
    height: 2.75rem;
    border-radius: 50%;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    box-shadow: 0 2px 8px oklch(0% 0 0 / 12%);
    display: flex;
    align-items: center;
    justify-content: center;
    transition:
      box-shadow 0.2s ease,
      border-color 0.2s ease;
    overflow: visible;
    cursor: pointer;
  }

  .fab-btn:hover {
    box-shadow: 0 4px 16px oklch(0% 0 0 / 20%);
    border-color: var(--color-accent);
  }

  .fab-btn :global(> div) {
    position: relative;
    width: 100% !important;
    height: 100% !important;
  }

  .fab-btn :global(button) {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 !important;
    border-radius: 50%;
  }

  @media (max-width: 640px) {
    .site-layout {
      grid-template-columns: 1fr;
      grid-template-areas: 'center';
      padding-bottom: 64px;
    }

    .left-col {
      display: none;
    }

    .floating-controls {
      display: none;
    }
  }
</style>
