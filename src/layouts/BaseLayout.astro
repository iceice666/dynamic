---
import { ClientRouter, fade } from 'astro:transitions';
import '../styles/global.css';
import LeftNav from '../components/LeftNav.astro';
import BottomNav from '../components/BottomNav.astro';
import AuthorBio from '../components/AuthorBio.astro';

interface Props {
  title: string;
  contentLang?: string;
  toc?: { depth: number; slug: string; text: string }[];
}

const { title, contentLang } = Astro.props;
---

<!doctype html>
<html lang={contentLang || 'en'} transition:animate="none">
  <head>
    <ClientRouter />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <!-- Blocking script: apply dark class + accent hue before paint (no FOUC) -->
    <script is:inline>
      var THEME_HANDLER_KEY = '__dynamicApplyThemeSettingsHandler__';

      function resolveTargetDocument(input) {
        if (input && input.documentElement) return input;
        if (input && input.newDocument && input.newDocument.documentElement)
          return input.newDocument;
        return document;
      }

      function applyThemeSettings(target) {
        const targetDocument = resolveTargetDocument(target);
        const root = targetDocument.documentElement;
        const theme = localStorage.getItem('dynamic:theme') || 'system';
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (theme === 'dark' || (theme === 'system' && prefersDark)) {
          root.classList.add('dark');
        } else {
          root.classList.remove('dark');
        }

        // Always set accent-hue to a valid value first (even if rainbow is active)
        const hue = localStorage.getItem('dynamic:accent-hue') || '255';
        root.style.setProperty('--accent-hue', hue);

        const rainbow = localStorage.getItem('dynamic:rainbow-mode') === 'true';
        if (rainbow) {
          const rawSpeed = parseInt(localStorage.getItem('dynamic:rainbow-speed') || '20', 10);
          const speed = Number.isFinite(rawSpeed) ? rawSpeed : 20;
          const duration = 60 - (speed / 100) * 58;
          root.style.setProperty('--rainbow-duration', duration + 's');
          // Use requestAnimationFrame to ensure hue is set before animation starts
          requestAnimationFrame(() => {
            root.classList.add('rainbow-active');
          });
        } else {
          root.classList.remove('rainbow-active');
        }

        const lang = localStorage.getItem('dynamic:lang') || 'en';
        root.dataset.lang = lang;
        if (!root.getAttribute('data-content-lang')) {
          root.lang = lang === 'zh-tw' ? 'zh-TW' : 'en';
        }

        // Update i18n aria-label attributes
        const ariaAttr = 'data-aria-' + lang;
        targetDocument.querySelectorAll('[' + ariaAttr + ']').forEach(function (el) {
          el.setAttribute('aria-label', el.getAttribute(ariaAttr));
        });
      }

      // Apply on initial load
      applyThemeSettings();

      // Reapply on View Transitions navigation
      const previousThemeHandler = window[THEME_HANDLER_KEY];
      if (typeof previousThemeHandler === 'function') {
        document.removeEventListener('astro:page-load', previousThemeHandler);
      }
      window[THEME_HANDLER_KEY] = applyThemeSettings;
      document.addEventListener('astro:page-load', () => applyThemeSettings());
      document.addEventListener('astro:before-swap', (event) => applyThemeSettings(event));
    </script>
  </head>
  <body>
    <div class="site-layout">
      <!-- Left: Nav -->
      <aside class="left-col">
        <div class="left-col-inner">
          <LeftNav currentPath={Astro.url.pathname} />
        </div>
      </aside>

      <!-- Center: Content -->
      <main class="center-col" transition:animate={fade({ duration: '0.2s' })}>
        <slot />
      </main>

      <!-- Right: Panel -->
      <aside class="right-col">
        <div class="right-col-inner">
          <slot name="right-panel" />
          <div class="author-bio-wrapper" transition:persist>
            <AuthorBio />
          </div>
        </div>
      </aside>
    </div>
    <BottomNav currentPath={Astro.url.pathname} />
  </body>
</html>

<style>
  .site-layout {
    display: grid;
    grid-template-columns: clamp(160px, 20vw, 240px) 1fr 280px;
    grid-template-areas: 'left center right';
    min-height: 100vh;
    max-width: 1200px;
    margin: 0 auto;
  }

  .left-col {
    grid-area: left;
    border-right: 1px solid var(--color-border);
    position: sticky;
    top: 0;
    height: 100vh;
  }

  .left-col-inner {
    height: 100%;
  }

  .center-col {
    grid-area: center;
    min-width: 0;
    padding: 2rem 1.5rem;
  }

  .right-col {
    grid-area: right;
    border-left: 1px solid var(--color-border);
    position: sticky;
    top: 0;
    height: 100vh;
    overflow-y: auto;
  }

  .right-col-inner {
    display: flex;
    flex-direction: column;
    min-height: 100%;
  }

  .author-bio-wrapper {
    margin-top: auto;
  }

  @media (max-width: 1024px) {
    .site-layout {
      grid-template-columns: clamp(160px, 20vw, 240px) 1fr;
      grid-template-areas:
        'left center'
        'left right';
    }

    .right-col {
      grid-area: right;
      position: static;
      height: auto;
      border-left: none;
      border-top: 1px solid var(--color-border);
    }
  }

  @media (max-width: 640px) {
    .site-layout {
      grid-template-columns: 1fr;
      grid-template-areas:
        'center'
        'right';
      padding-bottom: 64px;
    }

    .left-col {
      display: none;
    }

    .right-col {
      position: static;
      height: auto;
      border-left: none;
      border-top: 1px solid var(--color-border);
    }
  }
</style>
