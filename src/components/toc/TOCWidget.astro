---
import { t, i18nAriaLabel } from '$/i18n';

type Heading = { depth: number; slug: string; text: string };

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;
const { locale } = Astro.locals;

// Only show h2 and h3
const filteredHeadings = headings.filter((h: Heading) => h.depth === 2 || h.depth === 3);
---

{
  filteredHeadings.length > 0 && (
    <nav aria-label={i18nAriaLabel(locale, 'widget_toc_aria')}>
      <div class="toc-label label-uppercase mb-3">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="14"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <>
            <line x1="8" x2="21" y1="6" y2="6" />
            <line x1="8" x2="21" y1="12" y2="12" />
            <line x1="8" x2="21" y1="18" y2="18" />
            <line x1="3" x2="3.01" y1="6" y2="6" />
            <line x1="3" x2="3.01" y1="12" y2="12" />
            <line x1="3" x2="3.01" y1="18" y2="18" />
          </>
        </svg>
        {t(locale, 'widget_toc_label')}
      </div>
      <ul class="toc-list m-0 flex list-none flex-col p-0" data-toc-panel>
        <div class="toc-range-bar" data-toc-range-bar></div>
        {filteredHeadings.map((h) => (
          <li class={h.depth === 3 ? 'h3' : ''} data-toc-id={h.slug}>
            <a href={`#${h.slug}`}>{h.text}</a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<style>
  .toc-label {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .toc-list {
    position: relative;
    border-left: 2px solid var(--color-border);
  }

  .toc-range-bar {
    position: absolute;
    left: -2px;
    width: 2px;
    background: var(--color-accent);
    top: var(--range-top, 0px);
    height: var(--range-height, 0px);
    transition:
      top 0.3s ease-out,
      height 0.3s ease-out;
    pointer-events: none;
    z-index: 1;
  }

  .toc-list li a {
    font-size: 0.8125rem;
    color: var(--color-muted);
    text-decoration: none;
    line-height: 1.4;
    display: block;
    padding: 0.25rem 0.5rem 0.25rem 0.75rem;
    transition: color 0.15s ease;
  }

  .toc-list li a:hover {
    color: var(--color-foreground);
  }

  .toc-list li.h3 a {
    padding-left: 1.5rem;
    font-size: 0.75rem;
  }

  .toc-list li.active a {
    color: var(--color-accent);
    font-weight: 500;
  }
</style>
